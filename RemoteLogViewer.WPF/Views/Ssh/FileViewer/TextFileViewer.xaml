<UserControl
    x:Class="RemoteLogViewer.WPF.Views.Ssh.FileViewer.TextFileViewer"
    x:Name="Root"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="clr-namespace:RemoteLogViewer.WPF.Views.Ssh.FileViewer"
    xmlns:models="clr-namespace:RemoteLogViewer.Core.Models.Ssh.FileViewer"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022">

	<Grid>
		<Grid.RowDefinitions>
			<RowDefinition Height="Auto"/>
			<RowDefinition Height="2*" MinHeight="100"/>
			<RowDefinition Height="Auto"/>
			<RowDefinition Height="*" MinHeight="100"/>
		</Grid.RowDefinitions>

		<StackPanel Orientation="Horizontal" Margin="4" VerticalAlignment="Center">

			<TextBlock Width="180" FontSize="14" TextWrapping="Wrap">
                <Run Text="{Binding OpenedFilePath.Value}" FontWeight="SemiBold"/>
                <Run Text=" ("/>
                <Run Text="{Binding TotalBytes.Value, Converter={StaticResource FileSizeToFriendlyStringConverter}}"/>
                <Run Text=" )"/>
			</TextBlock>

			<Separator Margin="8,0"/>

			<StackPanel>
				<TextBlock FontSize="12" Text="Encoding"/>
				<ComboBox Width="160"
                          ItemsSource="{Binding ViewModel.AvailableEncodings}"
                          SelectedItem="{Binding ViewModel.SelectedEncoding.Value, Mode=TwoWay}"/>
			</StackPanel>

			<Separator Margin="8,0"/>

			<!-- Tail Start/Stop -->
			<Button Content="Tail Start"
                    Command="{Binding TailStartCommand}"
                    Visibility="{Binding IsTailRunning.Value, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>
			<Button Content="Tail Stop"
                    Command="{Binding TailStopCommand}"
                    Visibility="{Binding IsTailRunning.Value, Converter={StaticResource BooleanToVisibilityConverter}}"/>

			<Separator Margin="8,0"/>

			<!-- Download Range -->
			<StackPanel MinWidth="180">
				<TextBlock FontSize="12" Text="Download Selected Range"/>
				<StackPanel Orientation="Horizontal" Margin="0,4,0,0">
					<TextBox x:Name="StartLineBox" Width="80" />
					<TextBox x:Name="EndLineBox" Width="80" Margin="4,0"/>
					<Button Content="Save"
                            Click="SaveRangeButton_Click"
                            Visibility="{Binding IsRangeContentSaving.Value, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>
					<Button Content="Cancel"
                            Command="{Binding SaveRangeContentCancelCommand}"
                            Visibility="{Binding IsRangeContentSaving.Value, Converter={StaticResource BooleanToVisibilityConverter}}"/>
				</StackPanel>
				<ProgressBar Height="14"
                             Minimum="0" Maximum="1"
                             Value="{Binding SaveRangeProgress.Value}"/>
			</StackPanel>

			<Separator Margin="8,0"/>

			<!-- File Information -->
			<StackPanel MinWidth="150">
				<TextBlock FontSize="12" Text="File Information"/>
				<TextBlock>
                    <Run Text="{Binding WindowStartLine.Value}"/>
                    <Run Text=" - ("/>
                    <Run Text="{Binding VisibleLineCount.Value}"/>
                    <Run Text=") / "/>
                    <Run Text="{Binding TotalLines.Value}"/>
				</TextBlock>
				<ProgressBar Height="14"
                             Minimum="0" Maximum="1"
                             Value="{Binding FileLoadProgress.Value}"/>
			</StackPanel>

		</StackPanel>

		<Grid Grid.Row="1" ColumnDefinitions="Auto,*,Auto,Auto">

			<ScrollViewer VerticalScrollBarVisibility="Hidden">
				<ItemsControl ItemsSource="{Binding LineNumbers.Value}">
					<ItemsControl.ItemsPanel>
						<ItemsPanelTemplate>
							<VirtualizingStackPanel/>
						</ItemsPanelTemplate>
					</ItemsControl.ItemsPanel>
					<ItemsControl.ItemTemplate>
						<DataTemplate>
							<Border Background="#0D000000" Padding="4,0" Margin="0,0,4,0"
                                    Width="{Binding LineNumberColumnWidth.Value}">
								<TextBlock Text="{Binding}" 
                                           FontFamily="Consolas"
                                           HorizontalAlignment="Right"
                                           MouseLeftButtonDown="LineNumber_Click"/>
							</Border>
						</DataTemplate>
					</ItemsControl.ItemTemplate>
				</ItemsControl>
			</ScrollViewer>

			<ScrollViewer Grid.Column="1"
                          HorizontalScrollBarVisibility="Auto"
                          VerticalScrollBarVisibility="Hidden">
				<TextBlock FontFamily="Consolas"
                           TextWrapping="NoWrap"
                           Text="{Binding Content.Value}"
                           LineHeight="16"/>
			</ScrollViewer>

			<Button Grid.Column="2"
                    Background="LightPink"
                    Command="{Binding ShowMoreCommand}"
                    Visibility="{Binding IsTruncated.Value}">
				<Button.ToolTip>
					<TextBlock>
                        <Run Text="Show more ("/>
                        <Run Text="{Binding TruncatedCharacterCount.Value}"/>
                        <Run Text=" letters)"/>
					</TextBlock>
				</Button.ToolTip>
				<TextBlock Text=">"/>
			</Button>

			<ScrollViewer Grid.Column="3" VerticalScrollBarVisibility="Visible">
				<Grid Height="{Binding TotalHeight.Value}"/>
			</ScrollViewer>
		</Grid>

		<GridSplitter Grid.Row="2"
                      VerticalAlignment="Top"
                      ResizeDirection="Rows"
                      HorizontalAlignment="Stretch"
                      Height="8" Margin="0,5,0,0"/>

		<TabControl Grid.Row="3">
			<TabItem Header="Grep">
				<Grid RowDefinitions="Auto,*">
					<StackPanel Orientation="Horizontal" >
						<TextBox Width="260" Text="{Binding GrepQuery.Value, Mode=TwoWay}"/>
						<TextBox Width="80" Text="{Binding GrepStartLine.Value, Mode=TwoWay, Converter={StaticResource LongToDoubleConverter}}"/>
						<Button Content="Search" Command="{Binding GrepCommand}" Visibility="{Binding IsGrepRunning.Value, Mode=OneWay, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>
						<Button Content="Cancel" Command="{Binding GrepCancelCommand}" Visibility="{Binding IsGrepRunning.Value, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}"/>
						<ProgressBar Width="120" Height="14" Minimum="0" Maximum="1" Value="{Binding GrepProgress.Value, Mode=OneWay}" Visibility="{Binding IsGrepRunning.Value, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}"/>
						<TextBlock VerticalAlignment="Center">
							<Run Text="結果:"/>
							<Run Text="{Binding GrepResults.Count, Mode=OneWay}"/>
						</TextBlock>
					</StackPanel>
					<ScrollViewer
						Grid.Row="1"
						VerticalScrollBarVisibility="Auto"
						Padding="0,8"
						HorizontalScrollBarVisibility="Auto">
						<ItemsControl ItemsSource="{Binding GrepResults}">
							<ItemsControl.ItemTemplate>
								<DataTemplate DataType="models:TextLine">
									<Grid ColumnDefinitions="Auto,*" MinHeight="16">
										<Border Background="#0D000000" Padding="4,0" Margin="0,0,4,0" Width="{Binding ViewModel.LineNumberColumnWidth.Value, ElementName=Root, Mode=OneWay}">
											<TextBlock>
												<Hyperlink Click="GrepResultLineButton_Click">
													<TextBlock Text="{Binding LineNumber}" Padding="0" MinWidth="0" HorizontalAlignment="Right" FontFamily="Consolas"/>
												</Hyperlink>
											</TextBlock>
										</Border>
										<TextBlock Grid.Column="1" Text="{Binding Content}" IsTextSelectionEnabled="True" FontFamily="Consolas"/>
									</Grid>
								</DataTemplate>
							</ItemsControl.ItemTemplate>
						</ItemsControl>
					</ScrollViewer>
				</Grid>
			</TabItem>
			<TabItem x:Name="SelectedLineView" Header="選択行表示" IsClosable="False">
				<Grid VerticalAlignment="Stretch">
					<ScrollViewer
						 VerticalScrollBarVisibility="Auto"
						 HorizontalScrollBarVisibility="Disabled"
						 VerticalAlignment="Stretch">
						<Grid ColumnDefinitions="Auto,*" MinHeight="16" VerticalAlignment="Stretch">
							<Border Background="#0D000000" Padding="4,0" Margin="0,0,4,0" Width="{Binding ViewModel.LineNumberColumnWidth.Value, Mode=OneWay}">
								<TextBlock Text="{Binding ViewModel.PickedupTextLine.Value.LineNumber,Mode=OneWay}" FontFamily="Consolas" Foreground="Gray" HorizontalAlignment="Right"/>
							</Border>
							<RichTextBox
								IsReadOnly="True"
								Grid.Column="1"
								x:Name="PickedupRichTextBlock"
								FontFamily="Consolas"
								IsTextSelectionEnabled="True"
								TextWrapping="Wrap"
								LineHeight="16"
								LineStackingStrategy="BlockLineHeight">
								<FlowDocument>
									<Paragraph LineHeight="16">
										<Run Text="{Binding ViewModel.PickedupTextLine.Value.Content, Mode=OneWay}" />
									</Paragraph>
								</FlowDocument>
							</RichTextBox>
						</Grid>
					</ScrollViewer>
				</Grid>
			</TabItem>
		</TabControl>

	</Grid>
</UserControl>